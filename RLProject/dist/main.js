(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,a,i,o,s=[],u=!0,l=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=i.call(n)).done)&&(s.push(r.value),s.length!==e);u=!0);}catch(t){l=!0,a=t}finally{try{if(!u&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw a}}return s}}(t,e)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,s(r.key),r)}}function i(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function o(t,e,n){return(e=s(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(e){var n=function(e,n){if("object"!==t(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var a=r.call(e,"string");if("object"!==t(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===t(n)?n:String(n)}var u=function(){function t(){r(this,t),o(this,"array_functions",[])}return i(t,null,[{key:"argMax",value:function(t){return t.map((function(t,e){return[t,e]})).reduce((function(t,e){return e[0]>t[0]?e:t}))[1]}},{key:"zeros",value:function(e){if(1==e.length)return Array(e[0]).fill(0);for(var n=[],r=0;r<e[0];r++)n.push(t.zeros(e.slice(1)));return n}},{key:"ones",value:function(e){if(1==e.length)return Array(e[0]).fill(1);for(var n=[],r=0;r<e[0];r++)n.push(t.ones(e.slice(1)));return n}},{key:"ndarray",value:function(e,n){if(1==e.length)return Array(e[0]).fill(n);for(var r=[],a=0;a<e[0];a++)r.push(t.ndarray(e.slice(1),n));return r}},{key:"randomChoice",value:function(t){return t[Math.floor(Math.random()*t.length)]}},{key:"range",value:function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=[],a=t;a<e;++a)a%n||r.push(a);return r}},{key:"vAdd",value:function(t,e){for(var n=[],r=0;r<t.length;r++)n.push(t[r]+e[r]);return n}},{key:"vSub",value:function(t,e){for(var n=[],r=0;r<t.length;r++)n.push(t[r]-e[r]);return n}},{key:"vConstMul",value:function(t,e){for(var n=0;n<t.length;n++)t[n]*=e;return t}},{key:"vSquare",value:function(t,e){for(var n=0;n<t.length;n++){var r;t[r=n]=Math.pow(t[r],e)}return t}}]),t}(),l=function(){function t(){r(this,t),this.element=this.createElement(),this.setType("explorer")}return i(t,[{key:"createElement",value:function(){var t=document.createElement("div");return t.className="agent",t}},{key:"setType",value:function(t){switch(t){case"exploitater":this.element.style.backgroundColor="Crimson";break;case"explorer":this.element.style.backgroundColor="Darkcyan"}}},{key:"getElement",value:function(){return this.element}},{key:"show",value:function(t){this.element.style.visibility=t?"":"hidden"}}]),t}(),c=function(){function t(){r(this,t);var n=e(this.createNode(),2);this.element=n[0],this.agents=n[1],this.setState("open"),this.showAllAgent(!1)}return i(t,[{key:"createNode",value:function(){var t=document.createElement("div");t.className="grid_cell",t.innerHTML='   <div class = "inner_item">\n                                    <div class="value">0.0</div>\n                                    <div class="reward">r=0.0</div>\n                                <div>';for(var e=t.getElementsByClassName("inner_item")[0],n=[],r=[20,50,80],a=0;a<3;a++)for(var i=0;i<3;i++){var o=new l;o.getElement().style.top="".concat(r[a],"%"),o.getElement().style.left="".concat(r[i],"%"),n.push(o),e.insertBefore(o.getElement(),e.firstChild)}return[t,n]}},{key:"getElement",value:function(){return this.element}},{key:"setState",value:function(t){switch(t){case"S":this.element.style.backgroundColor="Cyan";break;case"F":this.element.style.backgroundColor="white";break;case"H":this.element.style.backgroundColor="Lightblue";break;case"G":this.element.style.backgroundColor="Chartreuse"}}},{key:"showAllAgent",value:function(t){this.agents.forEach((function(e){return e.show(t)}))}},{key:"showAgent",value:function(t,e){this.agents[t].show(e)}}]),t}(),h=function(){function t(n,a,i){r(this,t),this.width=n,this.height=a;var o=e(this.createElement(n,a),2);this.element=o[0],this.cellMap=o[1],this.resizeCell(i)}return i(t,[{key:"resizeCell",value:function(t){this.element.style.gridTemplateColumns="".concat(t,"px ").repeat(this.width),this.element.style.gridTemplateRows="".concat(t,"px ").repeat(this.height)}},{key:"getElement",value:function(){return this.element}},{key:"createElement",value:function(t,e){var n=document.createElement("div");n.className="grid_map";for(var r=Array.from(Array(e),(function(){return new Array(t)})),a=0;a<e;a++)for(var i=0;i<t;i++){var o=new c;n.appendChild(o.getElement()),r[a][i]=o}return[n,r]}},{key:"applyMap",value:function(t){for(var e=0;e<this.height;e++)for(var n=0;n<this.width;n++)this.cellMap[e][n].setState(t[e][n])}},{key:"showAgent",value:function(t,e,n,r){this.cellMap[e][t].showAgent(n,r)}}]),t}(),f=function(){function t(e,n){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.15,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.95,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:.1;r(this,t),this.states=e,this.actions=n,this.epsilon=a,this.step_size=i,this.gamma=o,this.q_values=u.zeros([e.length,n.length]),this.past_state=null,this.past_action=null,this.kappa=s,this.tau=u.zeros([e.length,n.length])}return i(t,[{key:"choose_action",value:function(t){if(Math.random()<this.epsilon)return u.randomChoice(this.actions);var e=this.tau[t];e=u.vSquare(e,.5),e=u.vConstMul(e,this.kappa);var n=u.vAdd(this.q_values[t],e),r=u.argMax(n);return this.actions[r]}},{key:"start",value:function(t){return this.past_state=t,this.past_action=this.choose_action(t),this.past_action}},{key:"step",value:function(t,e){this.update_q(this.past_state,this.past_action,t,e);var n=this.choose_action(t);return this.past_state=t,this.past_action=n,this.updateTau(this.past_state,this.past_action),this.past_action}},{key:"updateTau",value:function(t,e){for(var n=0;n<this.tau.length;n++)this.tau[n]=u.vAdd(this.tau[n],u.ones([this.tau.length]));this.tau[t][e]=0}},{key:"update_q",value:function(t,e,n,r){var a=n+(-1==r?0:this.gamma*Math.max(this.q_values[r]))-this.q_values[t][e];this.q_values[t][e]+=a}},{key:"end",value:function(t){this.update_q(this.past_state,this.past_action,t,-1),this.past_state=-1,this.past_action=-1}}]),t}();o(f,"tau",[]);var v=function(){function t(e){r(this,t),this.map_size=e,this.state_list=u.range(0,e*e),this.action_list=u.range(0,4),this.map=this.generateRandomMap(e)}return i(t,[{key:"getMap",value:function(){return this.map}},{key:"getStates",value:function(){return this.state_list}},{key:"getActions",value:function(){return this.action_list}},{key:"generateRandomMap",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.8,n=!1,r=[];!n;){r=u.ndarray([t,t]," ");for(var a=0;a<t;a++)for(var i=0;i<t;i++)r[a][i]=Math.random()<e?"F":"H";r[0][0]="S",r[t-1][t-1]="G",n=this.isValid(r,t)}return r}},{key:"isValid",value:function(t,n){var r=[],a=new Set;for(r.push([0,0]);0<r.length;){var i,o,s=e(r.pop(),2);i=s[0],o=s[1];var u="".concat(i,",").concat(o);if(!a.has(u)){a.add(u);for(var l=[[1,0],[0,1],[-1,0],[0,-1]],c=0;c<l.length;c++){var h=e(l[c],2),f=i+h[0],v=o+h[1];if(!(f<0||f>=n||v<0||v>=n)){if("G"==t[f][v])return!0;"H"!=t[f][v]&&r.push([f,v])}}}}return!1}},{key:"step",value:function(t,e){var n=this.get_next_state(t,e),r=this.reward(n);return console.log("nest_state",n),console.log("reward",r),console.log("done",this.is_done(n)),[n,r,this.is_done(n)]}},{key:"is_done",value:function(t){return t==this.map_size*this.map_size-1}},{key:"get_next_state",value:function(t,n){var r,a,i=e(this.state_to_coordinate(t),2);r=i[0],a=i[1];var o={0:[-1,0],1:[0,1],2:[1,0],3:[0,-1]}[n];console.log(r),console.log("move",o[0]);var s=r+o[0],u=a+o[1];return this.is_out(s,u)?t:"H"==this.map[a][r]?0:this.coordinate_to_state(s,u)}},{key:"state_to_coordinate",value:function(t){var e=Math.floor(t/this.map_size);return[t%this.map_size,e]}},{key:"coordinate_to_state",value:function(t,e){return this.map_size*e+t}},{key:"is_out",value:function(t,e){return!(0<=t&&t<this.map_size&&0<=e&&e<this.map_size)}},{key:"reward",value:function(t){var n,r;if(-1==t)return 0;var a=e(this.state_to_coordinate(t),2);return n=a[0],r=a[1],{S:0,F:0,H:-1,G:1}[t=this.map[r][n]]}}]),t}(),p=new v(10),y=new f(p.getStates(),p.getActions()),m=p.getMap(),d=new h(10,10,100);d.applyMap(m);var g=y.start(0);for(d.showAgent(0,0,0,!0);;){var _,k,b=e(p.state_to_coordinate(y.past_state),2);_=b[0],k=b[1],d.showAgent(_,k,0,!1);var w,A,S,M=e(p.step(y.past_state,g),3);if(w=M[0],A=M[1],S=M[2],g=y.step(w,A)[k]=p.state_to_coordinate(y.past_state),d.showAgent(_,k,0,!0),1==S)break;console.log(A)}})();